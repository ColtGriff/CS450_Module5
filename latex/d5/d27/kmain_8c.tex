\hypertarget{kmain_8c}{}\doxysection{kernel/core/kmain.c File Reference}
\label{kmain_8c}\index{kernel/core/kmain.c@{kernel/core/kmain.c}}
{\ttfamily \#include $<$stdint.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$system.\+h$>$}\newline
{\ttfamily \#include $<$core/io.\+h$>$}\newline
{\ttfamily \#include $<$core/serial.\+h$>$}\newline
{\ttfamily \#include $<$core/tables.\+h$>$}\newline
{\ttfamily \#include $<$core/interrupts.\+h$>$}\newline
{\ttfamily \#include $<$mem/heap.\+h$>$}\newline
{\ttfamily \#include $<$mem/paging.\+h$>$}\newline
{\ttfamily \#include \char`\"{}modules/mpx\+\_\+supt.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modules/\+R1/commhand.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modules/\+R2/\+R2commands.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modules/\+R2/\+R2\+\_\+\+Internal\+\_\+\+Functions\+\_\+\+And\+\_\+\+Structures.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modules/\+R3/\+R3commands.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modules/\+R4/\+R4commands.\+h\char`\"{}}\newline
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{kmain_8c_a406c20548822065e144564476378f8a1}{kmain}} (void)
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{kmain_8c_a406c20548822065e144564476378f8a1}\label{kmain_8c_a406c20548822065e144564476378f8a1}} 
\index{kmain.c@{kmain.c}!kmain@{kmain}}
\index{kmain@{kmain}!kmain.c@{kmain.c}}
\doxysubsubsection{\texorpdfstring{kmain()}{kmain()}}
{\footnotesize\ttfamily void kmain (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Definition at line 31 of file kmain.\+c.


\begin{DoxyCode}{0}
\DoxyCodeLine{32 \{}
\DoxyCodeLine{33    \textcolor{comment}{// extern uint32\_t magic;}}
\DoxyCodeLine{34    \textcolor{comment}{// Uncomment if you want to access the multiboot header}}
\DoxyCodeLine{35    \textcolor{comment}{// extern void *mbd;}}
\DoxyCodeLine{36    \textcolor{comment}{// char *boot\_loader\_name = (char*)((long*)mbd)[16];}}
\DoxyCodeLine{37 }
\DoxyCodeLine{38    \textcolor{comment}{// 0) Initialize Serial I/O}}
\DoxyCodeLine{39    \textcolor{comment}{// functions to initialize serial I/O can be found in serial.c}}
\DoxyCodeLine{40    \textcolor{comment}{// there are 3 functions to call}}
\DoxyCodeLine{41 }
\DoxyCodeLine{42    \mbox{\hyperlink{serial_8h_a7078c07ff8b2c48780558549a8f7cf90}{init\_serial}}(\mbox{\hyperlink{serial_8h_a00dbb3ab1c59e14699be9393693e2248}{COM1}});}
\DoxyCodeLine{43    \mbox{\hyperlink{serial_8h_a3f4008da5feabfb7e086f6673a81104b}{set\_serial\_in}}(\mbox{\hyperlink{serial_8h_a00dbb3ab1c59e14699be9393693e2248}{COM1}});}
\DoxyCodeLine{44    \mbox{\hyperlink{serial_8h_ae97b87ee1f57c687e7fca6f9958e03ef}{set\_serial\_out}}(\mbox{\hyperlink{serial_8h_a00dbb3ab1c59e14699be9393693e2248}{COM1}});}
\DoxyCodeLine{45 }
\DoxyCodeLine{46    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Starting MPX boot sequence..."{}});}
\DoxyCodeLine{47    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Initialized serial I/O on COM1 device..."{}});}
\DoxyCodeLine{48 }
\DoxyCodeLine{49    \textcolor{comment}{// 1) Initialize the support software by identifying the current}}
\DoxyCodeLine{50    \textcolor{comment}{//     MPX Module.  This will change with each module.}}
\DoxyCodeLine{51    \textcolor{comment}{// you will need to call mpx\_init from the mpx\_supt.c}}
\DoxyCodeLine{52 }
\DoxyCodeLine{53    \mbox{\hyperlink{mpx__supt_8c_a53332c6a3107a4feed6e2e79690a6ffa}{mpx\_init}}(\mbox{\hyperlink{mpx__supt_8h_a05541487bcf6e840b918f0a6ef097024}{MODULE\_R4}});}
\DoxyCodeLine{54 }
\DoxyCodeLine{55    \textcolor{comment}{// 2) Check that the boot was successful and correct when using grub}}
\DoxyCodeLine{56    \textcolor{comment}{// Comment this when booting the kernel directly using QEMU, etc.}}
\DoxyCodeLine{57    \textcolor{comment}{//if ( magic != 0x2BADB002 )\{}}
\DoxyCodeLine{58    \textcolor{comment}{//  kpanic("{}Boot was not error free. Halting."{});}}
\DoxyCodeLine{59    \textcolor{comment}{//\}}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61    \textcolor{comment}{// 3) Descriptor Tables -\/-\/ tables.c}}
\DoxyCodeLine{62    \textcolor{comment}{//  you will need to initialize the global}}
\DoxyCodeLine{63    \textcolor{comment}{// this keeps track of allocated segments and pages}}
\DoxyCodeLine{64    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Initializing descriptor tables..."{}});}
\DoxyCodeLine{65 }
\DoxyCodeLine{66    \mbox{\hyperlink{tables_8h_a86bb50044169930202cc403376ef40c3}{init\_gdt}}();}
\DoxyCodeLine{67    \mbox{\hyperlink{tables_8h_a35fe413107af682030ab7a4b6dff19b8}{init\_idt}}();}
\DoxyCodeLine{68 }
\DoxyCodeLine{69    \mbox{\hyperlink{interrupts_8h_afbc0dbef6f15e2df21b38724ea38c483}{init\_pic}}();}
\DoxyCodeLine{70    \mbox{\hyperlink{system_8h_ac5d15f274bc9b1e96230f3d3c60fd1f8}{sti}}();}
\DoxyCodeLine{71 }
\DoxyCodeLine{72    \textcolor{comment}{// 4)  Interrupt vector table -\/-\/  tables.c}}
\DoxyCodeLine{73    \textcolor{comment}{// this creates and initializes a default interrupt vector table}}
\DoxyCodeLine{74    \textcolor{comment}{// this function is in tables.c}}
\DoxyCodeLine{75 }
\DoxyCodeLine{76    \mbox{\hyperlink{interrupts_8h_ad17d9a8aa78440af8fc40d3fd55dbad8}{init\_irq}}();}
\DoxyCodeLine{77 }
\DoxyCodeLine{78    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Interrupt vector table initialized!"{}});}
\DoxyCodeLine{79 }
\DoxyCodeLine{80    \textcolor{comment}{// 5) Virtual Memory -\/-\/ paging.c  -\/-\/ init\_paging}}
\DoxyCodeLine{81    \textcolor{comment}{//  this function creates the kernel's heap}}
\DoxyCodeLine{82    \textcolor{comment}{//  from which memory will be allocated when the program calls}}
\DoxyCodeLine{83    \textcolor{comment}{// sys\_alloc\_mem UNTIL the memory management module  is completed}}
\DoxyCodeLine{84    \textcolor{comment}{// this allocates memory using discrete "{}pages"{} of physical memory}}
\DoxyCodeLine{85    \textcolor{comment}{// NOTE:  You will only have about 70000 bytes of dynamic memory}}
\DoxyCodeLine{86    \textcolor{comment}{//}}
\DoxyCodeLine{87    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Initializing virtual memory..."{}});}
\DoxyCodeLine{88 }
\DoxyCodeLine{89    \mbox{\hyperlink{paging_8h_a919b727f386797a8b9d8eceb5c4e7313}{init\_paging}}();}
\DoxyCodeLine{90 }
\DoxyCodeLine{91    \textcolor{comment}{// 6) Call YOUR command handler -\/  interface method}}
\DoxyCodeLine{92    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Transferring control to commhand..."{}});}
\DoxyCodeLine{93    \textcolor{comment}{//commhand(); //Removed for R4}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95    \mbox{\hyperlink{R2__Internal__Functions__And__Structures_8c_aa93ee76bdb5b9aac80f93031a9ea918e}{allocateQueues}}();}
\DoxyCodeLine{96    \textcolor{comment}{//allocateAlarms();}}
\DoxyCodeLine{97 }
\DoxyCodeLine{98    \mbox{\hyperlink{R2commands_8c_a3cd65702d00f1828d24a99898123fc7f}{createPCB}}(\textcolor{stringliteral}{"{}Commhand"{}}, \textcolor{charliteral}{'s'}, 9);}
\DoxyCodeLine{99    \mbox{\hyperlink{structPCB}{PCB}} *new\_pcb = \mbox{\hyperlink{R2__Internal__Functions__And__Structures_8c_a2e9694bcc8559834a0e4749509faf4be}{findPCB}}(\textcolor{stringliteral}{"{}Commhand"{}});}
\DoxyCodeLine{100    \mbox{\hyperlink{structcontext}{context}} *cp = (\mbox{\hyperlink{structcontext}{context}} *)(new\_pcb-\/>\mbox{\hyperlink{structPCB_a927da593bccc4abb835f48da1557df42}{stackTop}});}
\DoxyCodeLine{101    \mbox{\hyperlink{string_8h_ace6ee45c30e71865e6eb635200379db9}{memset}}(cp, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structcontext}{context}}));}
\DoxyCodeLine{102    cp-\/>\mbox{\hyperlink{structcontext_a5e778314cc8c537f0a27726bfa673c8e}{fs}} = 0x10;}
\DoxyCodeLine{103    cp-\/>\mbox{\hyperlink{structcontext_a54fa688ce896c5cca606323d33e1f68c}{gs}} = 0x10;}
\DoxyCodeLine{104    cp-\/>\mbox{\hyperlink{structcontext_ae636622afec7fe9c8b18504168023d1e}{ds}} = 0x10;}
\DoxyCodeLine{105    cp-\/>\mbox{\hyperlink{structcontext_aca480d54d4be09cb005dc21e4ff05da1}{es}} = 0x10;}
\DoxyCodeLine{106    cp-\/>\mbox{\hyperlink{structcontext_a29cb887d9a426ddb24c04237bce5df6d}{cs}} = 0x8;}
\DoxyCodeLine{107    cp-\/>\mbox{\hyperlink{structcontext_a7ed33e51ef51493c861cd20aa919f2f9}{ebp}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})(new\_pcb-\/>\mbox{\hyperlink{structPCB_ad16b941b22b8d62d7b63c7d4ca15210d}{stack}});}
\DoxyCodeLine{108    cp-\/>\mbox{\hyperlink{structcontext_a5d56c844a4aa0dd6b7a7bf5b421cbf88}{esp}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})(new\_pcb-\/>\mbox{\hyperlink{structPCB_a927da593bccc4abb835f48da1557df42}{stackTop}});}
\DoxyCodeLine{109    cp-\/>\mbox{\hyperlink{structcontext_a48807bac5338e9bcd6183f2f2061400b}{eip}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})\mbox{\hyperlink{commhand_8c_acf65bd5a16579cc5bf4af7c8c994d28a}{commhand}}; \textcolor{comment}{// The function correlating to the process, ie. Proc1}}
\DoxyCodeLine{110    cp-\/>\mbox{\hyperlink{structcontext_a70a4605bd1b897c096f5cc7f730214db}{eflags}} = 0x202;}
\DoxyCodeLine{111 }
\DoxyCodeLine{112    \textcolor{comment}{// createPCB("{}Alarm"{}, 'a', 1);}}
\DoxyCodeLine{113    \textcolor{comment}{// PCB *AlarmPCB = findPCB("{}Alarm"{});}}
\DoxyCodeLine{114    \textcolor{comment}{// context *cpAlarm = (context *)(AlarmPCB-\/>stackTop);}}
\DoxyCodeLine{115    \textcolor{comment}{// memset(cpAlarm, 0, sizeof(context));}}
\DoxyCodeLine{116    \textcolor{comment}{// cpAlarm-\/>fs = 0x10;}}
\DoxyCodeLine{117    \textcolor{comment}{// cpAlarm-\/>gs = 0x10;}}
\DoxyCodeLine{118    \textcolor{comment}{// cpAlarm-\/>ds = 0x10;}}
\DoxyCodeLine{119    \textcolor{comment}{// cpAlarm-\/>es = 0x10;}}
\DoxyCodeLine{120    \textcolor{comment}{// cpAlarm-\/>cs = 0x8;}}
\DoxyCodeLine{121    \textcolor{comment}{// cpAlarm-\/>ebp = (u32int)(AlarmPCB-\/>stack);}}
\DoxyCodeLine{122    \textcolor{comment}{// cpAlarm-\/>esp = (u32int)(AlarmPCB-\/>stackTop);}}
\DoxyCodeLine{123    \textcolor{comment}{// cpAlarm-\/>eip = (u32int)alarmPCB; // The function correlating to the process, ie. Proc1}}
\DoxyCodeLine{124    \textcolor{comment}{// cpAlarm-\/>eflags = 0x202;}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126    \mbox{\hyperlink{R2commands_8c_a3cd65702d00f1828d24a99898123fc7f}{createPCB}}(\textcolor{stringliteral}{"{}Idle"{}}, \textcolor{charliteral}{'s'}, 0);}
\DoxyCodeLine{127    \mbox{\hyperlink{structPCB}{PCB}} *idlePCB = \mbox{\hyperlink{R2__Internal__Functions__And__Structures_8c_a2e9694bcc8559834a0e4749509faf4be}{findPCB}}(\textcolor{stringliteral}{"{}Idle"{}});}
\DoxyCodeLine{128    \mbox{\hyperlink{structcontext}{context}} *cpIDLE = (\mbox{\hyperlink{structcontext}{context}} *)(idlePCB-\/>\mbox{\hyperlink{structPCB_a927da593bccc4abb835f48da1557df42}{stackTop}});}
\DoxyCodeLine{129    \mbox{\hyperlink{string_8h_ace6ee45c30e71865e6eb635200379db9}{memset}}(cpIDLE, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structcontext}{context}}));}
\DoxyCodeLine{130    cpIDLE-\/>\mbox{\hyperlink{structcontext_a5e778314cc8c537f0a27726bfa673c8e}{fs}} = 0x10;}
\DoxyCodeLine{131    cpIDLE-\/>\mbox{\hyperlink{structcontext_a54fa688ce896c5cca606323d33e1f68c}{gs}} = 0x10;}
\DoxyCodeLine{132    cpIDLE-\/>\mbox{\hyperlink{structcontext_ae636622afec7fe9c8b18504168023d1e}{ds}} = 0x10;}
\DoxyCodeLine{133    cpIDLE-\/>\mbox{\hyperlink{structcontext_aca480d54d4be09cb005dc21e4ff05da1}{es}} = 0x10;}
\DoxyCodeLine{134    cpIDLE-\/>\mbox{\hyperlink{structcontext_a29cb887d9a426ddb24c04237bce5df6d}{cs}} = 0x8;}
\DoxyCodeLine{135    cpIDLE-\/>\mbox{\hyperlink{structcontext_a7ed33e51ef51493c861cd20aa919f2f9}{ebp}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})(idlePCB-\/>\mbox{\hyperlink{structPCB_ad16b941b22b8d62d7b63c7d4ca15210d}{stack}});}
\DoxyCodeLine{136    cpIDLE-\/>\mbox{\hyperlink{structcontext_a5d56c844a4aa0dd6b7a7bf5b421cbf88}{esp}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})(idlePCB-\/>\mbox{\hyperlink{structPCB_a927da593bccc4abb835f48da1557df42}{stackTop}});}
\DoxyCodeLine{137    cpIDLE-\/>\mbox{\hyperlink{structcontext_a48807bac5338e9bcd6183f2f2061400b}{eip}} = (\mbox{\hyperlink{system_8h_a757de76cafbcddaac0d1632902fe4cb8}{u32int}})\mbox{\hyperlink{mpx__supt_8c_a83abbeda22fc5e6c2b35523b64199c1c}{idle}}; \textcolor{comment}{// The function correlating to the process, ie. Proc1}}
\DoxyCodeLine{138    cpIDLE-\/>\mbox{\hyperlink{structcontext_a70a4605bd1b897c096f5cc7f730214db}{eflags}} = 0x202;}
\DoxyCodeLine{139 }
\DoxyCodeLine{140    \textcolor{keyword}{asm} \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}int \$60"{}});}
\DoxyCodeLine{141 }
\DoxyCodeLine{142    \textcolor{comment}{// 7) System Shutdown on return from your command handler}}
\DoxyCodeLine{143 }
\DoxyCodeLine{144    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Starting system shutdown procedure..."{}});}
\DoxyCodeLine{145 }
\DoxyCodeLine{146    \textcolor{comment}{/* Shutdown Procedure */}}
\DoxyCodeLine{147    \mbox{\hyperlink{system_8h_abdb09834267dd4a2a0d07d43ca4d230d}{klogv}}(\textcolor{stringliteral}{"{}Shutdown complete. You may now turn off the machine. (QEMU: C-\/a x)"{}});}
\DoxyCodeLine{148    \mbox{\hyperlink{system_8h_a954b0134ce21d80f0efb22c77e821da3}{hlt}}();}
\DoxyCodeLine{149 \}}

\end{DoxyCode}
